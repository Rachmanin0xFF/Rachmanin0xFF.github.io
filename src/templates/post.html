{% extends "base.html" %}

{% block header %}
<header>
  <h1><a href="../../">Adam Lastowka</a></h1>
</header>
{% endblock %}

{% block favicon_and_stylesheet %}
<link rel="icon" href="../../favicon.ico" type="image/x-icon">
<link rel="shortcut icon" href="../../favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="../../style.css">
<link rel="stylesheet" href="../../lightfair.css">
<script src="../../highlight.min.js"></script>
<script src="https://unpkg.com/highlightjs-copy/dist/highlightjs-copy.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/highlightjs-copy/dist/highlightjs-copy.min.css">
{% endblock %}

{% block nav_links %}
<a href="../../">Home</a>
<a href="../../about/">About</a>
<a href="../../qa/">Q&A</a>
{% endblock %}

{% block extra_head %}
<script>
  window.MathJax = {
    tex: {
      inlineMath: [
        ['$', '$'],
        ["\\(", "\\)"]
      ],
      displayMath: [
        ['$$', '$$'],
        ["\\[", "\\]"]
      ],
      processEscapes: true,
    },
    chtml: {
      scale: 1,
      displayAlign: 'center'
    }
  };
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@4/tex-mml-chtml.js"></script>

{% if plotly %}
<script async defer src="https://cdn.plot.ly/plotly-latest.min.js"></script>{% endif %}
{% endblock %}

{% block content %}
<h1>{{ title }}</h1>
<time>{{ date }}</time>
<div class="post-body">
  {{ html }}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  if (window.hljs) {
    hljs.highlightAll();
    hljs.addPlugin(new CopyButtonPlugin());
  }

  // Add footnote tooltips
  let activeTooltip = null;

  document.querySelectorAll('.footnote-ref').forEach(ref => {
    const fnId = ref.getAttribute('href');
    if (fnId) {
      // Escape the ID selector (colons need to be escaped in querySelector)
      const escapedId = fnId.replace(/:/g, '\\:');
      const fnElement = document.querySelector(escapedId);
      if (fnElement) {
        let html = fnElement.innerHTML
          .replace(/<a class="footnote-backref".*?<\/a>/s, '') // Remove the backref link
          .trim();

        // Remove <p> tags if the content is wrapped in them
        html = html.replace(/^<p>(.*)<\/p>$/s, '$1');

        const tooltip = document.createElement('div');
        tooltip.className = 'footnote-tooltip';
        tooltip.innerHTML = html;

        // Desktop: hover to show/hide
        ref.addEventListener('mouseenter', () => {
          if (activeTooltip && activeTooltip !== tooltip) {
            activeTooltip.classList.remove('visible');
          }
          tooltip.classList.add('visible');
          activeTooltip = tooltip;
        });

        ref.addEventListener('mouseleave', () => {
          setTimeout(() => {
            if (!tooltip.matches(':hover')) {
              tooltip.classList.remove('visible');
              if (activeTooltip === tooltip) activeTooltip = null;
            }
          }, 50);
        });

        tooltip.addEventListener('mouseenter', () => {
          tooltip.classList.add('visible');
          activeTooltip = tooltip;
        });

        tooltip.addEventListener('mouseleave', () => {
          setTimeout(() => {
            if (!ref.matches(':hover')) {
              tooltip.classList.remove('visible');
              if (activeTooltip === tooltip) activeTooltip = null;
            }
          }, 50);
        });

        // Mobile: click to toggle
        ref.addEventListener('click', (e) => {
          // If clicking a link inside the tooltip, allow it
          if (e.target.tagName === 'A' && tooltip.contains(e.target)) {
            return;
          }

          e.preventDefault();
          if (tooltip.classList.contains('visible')) {
            tooltip.classList.remove('visible');
            activeTooltip = null;
          } else {
            if (activeTooltip && activeTooltip !== tooltip) {
              activeTooltip.classList.remove('visible');
            }
            tooltip.classList.add('visible');
            activeTooltip = tooltip;
          }
        });

        // Close when clicking elsewhere
        document.addEventListener('click', (e) => {
          if (!ref.contains(e.target) && !tooltip.contains(e.target)) {
            if (tooltip.classList.contains('visible')) {
              tooltip.classList.remove('visible');
              if (activeTooltip === tooltip) activeTooltip = null;
            }
          }
        });

        ref.appendChild(tooltip);
      }
    }
  });
</script>
{% endblock %}